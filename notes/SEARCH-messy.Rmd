# here, I will be reading in SEARCH rhum quality monitor data, reviewing it, and mapping it over NARR temperature data. This will serve as preparation (quality control) before doing the exposure assesment

# setting working directory {r setup, include=FALSE}

```{r}
knitr::opts_knit$set(root.dir = getwd())

```


# loading in necessary packages

```{r}
library(dplyr)
library(raster)
library(sf)
library(rgdal)
library(tidyr)
library(tidyverse)
library(ncdf4)

```


# creating raster files of the NARR data

```{r}

#Daily mean air temperature
air.2018.raster =
  stack("data/raw/narr/air_temp_daily_mean/air.sfc.2018.nc")
air.2019.raster = 
  stack("data/raw/narr/air_temp_daily_mean/air.sfc.2019.nc")
air.2020.raster = 
  stack("data/raw/narr/air_temp_daily_mean/air.sfc.2020.nc")

#Daily mean u-wind component
uwind.2018.raster = 
  stack("data/raw/narr/wind_u/uwnd.10m.2018.nc")
uwind.2019.raster = 
  stack("data/raw/narr/wind_u/uwnd.10m.2019.nc")
uwind.2020.raster = 
  stack("data/raw/narr/wind_u/uwnd.10m.2020.nc")

#Daily mean v-wind component
vwind.2018.raster = 
  stack("data/raw/narr/wind_v/vwnd.10m.2018.nc")
vwind.2019.raster = 
  stack("data/raw/narr/wind_v/vwnd.10m.2019.nc")
vwind.2020.raster = 
  stack("data/raw/narr/wind_v/vwnd.10m.2020.nc")

#Daily mean albedo
albedo.2018.raster = 
  stack("data/raw/narr/albedo/albedo.2018.nc")
albedo.2019.raster = 
  stack("data/raw/narr/albedo/albedo.2019.nc")
albedo.2020.raster = 
  stack("data/raw/narr/albedo/albedo.2020.nc")

#Daily mean accumulated total albedoitation
precip.2018.raster = 
  stack("data/raw/narr/accumulated_precip/apcp.2018.nc")
precip.2019.raster = 
  stack("data/raw/narr/accumulated_precip/apcp.2019.nc")
precip.2020.raster = 
  stack("data/raw/narr/accumulated_precip/apcp.2020.nc")

#Daily mean relative humidity
rhum.2018.raster = 
  stack("data/raw/narr/relative_humidity/rhum.2m.2018.nc")
rhum.2019.raster = 
  stack("data/raw/narr/relative_humidity/rhum.2m.2019.nc")
rhum.2020.raster = 
  stack("data/raw/narr/relative_humidity/rhum.2m.2020.nc")

#Daily mean planetery boundary layer height
pblh.2018.raster = 
  stack("data/raw/narr/planetary_boundary_layer_height/hpbl.2018.nc")
pblh.2019.raster = 
  stack("data/raw/narr/planetary_boundary_layer_height/hpbl.2019.nc")
pblh.2020.raster = 
  stack("data/raw/narr/planetary_boundary_layer_height/hpbl.2020.nc")

```

## extracting NARR projection for future use, setting up environment


```{r}
crs_projected <- st_crs(air.2018.raster)

```



# creating the search monitor dataset


```{r}
## creating SEARCH dataset using only the columns site number, latitude, longitude, removal_date, reinstall_date, removal_date2, reinstall_date2 from the revised excel file, but only the first 43 rows because there are only 43 monitors

search <- read.csv("data/interim/SEARCH_Stationary_Overview.csv") %>% 
  dplyr::select(Site_Number,	Latitude,	Longitude, Removal_Date,
                Reinstall_Date,	Removal_Date2,	Reinstall_Date2) %>% 
  dplyr::slice(1:43)

```

## projecting SEARCH dataset to match NARR data

```{r}
## creating the SEARCH air monitor site SF object, datum/epsg = WGS 84 in the same projection as the narr datasets

search_sites_sf <- search %>% 
  dplyr::select(Site_Number, Latitude, Longitude) %>%  
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)
 
search_sites_sf_lcc = st_transform(search_sites_sf, crs_projected)

```


# creating the wheelabrator sf object

```{r}
## creating a dataframe using Wheelabrator lon + lat coordinates 

x = 39.270195
y = -76.629099

wheelabrator_address <- data.frame(x,y)
  

## converting wheelabrator data fram to sf object
wheelabrator_sf <- wheelabrator_address %>%
  st_as_sf(coords = c("x","y"), crs = 4326)

## projecting wheelabrator sf object in sae projection as narr data
wheelabrator_sf_lcc = st_transform(wheelabrator_sf, crs_projected)

```

# quality control, plotting search sites over air temp NARR data

## creating a subset of air temperature from 2018


```{r}
air.slice <- raster::subset(air.2018.raster, 271)

air.slice2 <- air.slice - 273.15

```

## loading in baltimore and US shapefiles
```{r}
study_area <- readOGR("data/raw/shapefiles/BaltimoreCity.shp")
Bmore_sf = st_as_sf(study_area)
Bmore_sf_lcc = st_transform(Bmore_sf, proj)
Bmore <- st_cast(Bmore_sf_lcc$geometry, "POLYGON")

```
```{r}
MD <- readOGR("data/raw/shapefiles/MarylandState.shp")
MD_sf = st_as_sf(MD)
MD_sf_lcc = st_transform(MD_sf, proj)
Maryland <- st_cast(MD_sf_lcc$geometry, "POLYGON")
```

```{r}
US <- readOGR("data/raw/shapefiles/cb_2018_us_nation_5m/cb_2018_us_nation_5m.shp")
US_sf = st_as_sf(US)
US_sf_lcc = st_transform(US_sf, proj)
UnitedStates <- st_cast(US_sf_lcc$geometry, "POLYGON")

```

## cropping raster file to Baltimore shapefile
```{r}
r2 <- crop(air.slice2, extent(US_sf_lcc))
r3 <- mask(r2, US_sf_lcc)

```

## cropping raster file to Maryland shapefile
```{r}
r4 <- crop(air.slice2, extent(MD_sf_lcc))
r5 <- mask(r4, MD_sf_lcc)

```

## plot of SEARCH monitors over Bmore and US shapefiles, and NARR data
```{r}

plot(Maryland, col = 5)
plot(r3,
         main = "Mean Air Temperature 06-07-18",
         xlab = "False Easting",
         ylab = "False Northing",
         add=T
     )
plot(Bmore, col = 5, alpha=0.3, add=T)
plot(search_sites_sf_lcc, 
      pch = 16, cex = 0.01, col = 2, 
      add=T) 


```





# quality control, plotting search sites and wheelabrator point

## creating a wheelabratot sf object

```{r}
##creating a dataframe using Wheelabrator lon + lat coordinates 
x = -76.629099
y = 39.270195

wheelabrator_address <- data.frame(x,y)


## converting wheelabrator data fram to sf object
wheelabrator_sf <- wheelabrator_address %>%
  st_as_sf(coords = c("x","y"), crs = 4326) %>% 
  mutate(site = "wheelabrator incinerator")

## projecting wheelabrator sf object in sae projection as narr data
wheelabrator_sf_lcc = st_transform(wheelabrator_sf, crs_projected)

```

## creating the search monitor sf object
```{r}
search <- read.csv("data/interim/SEARCH_Stationary_Overview.csv") %>% 
  dplyr::select(Site_Number,	Latitude,	Longitude, Install_Date, Removal_Date,
                Reinstall_Date,	Removal_Date2,	Reinstall_Date2, Final_Date) %>% 
  dplyr::slice(1:43)

search_sites_sf <- search %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)

search_sites_sf_lcc = st_transform(search_sites_sf, crs_projected)

```



## loading in baltimore and US shapefiles
```{r}
study_area <- readOGR("data/raw/shapefiles/BaltimoreCity.shp")
Bmore_sf = st_as_sf(study_area)
Bmore_sf_wgs = st_transform(Bmore_sf, st_crs(search_sites_sf))
Bmore_polygon <- st_cast(Bmore_sf_wgs$geometry, "POLYGON")
Bmore_sf_lcc = st_transform(Bmore_sf, crs_projected)
Bmore <- st_cast(Bmore_sf_lcc$geometry, "POLYGON")

```

```{r}
MD <- readOGR("data/raw/shapefiles/MarylandState.shp")
MD_sf = st_as_sf(MD)
MD_sf_wgs = st_transform(MD_sf, st_crs(search_sites_sf))
MD_polygon <- st_cast(MD_sf_wgs$geometry, "POLYGON")
MD_polygon <- st_cast(MD_sf$geometry, "POLYGON")
MD_sf_lcc = st_transform(MD_sf, crs_projected)
Maryland <- st_cast(MD_sf_lcc$geometry, "POLYGON")
```

```{r}
US <- readOGR("data/raw/shapefiles/cb_2018_us_nation_5m/cb_2018_us_nation_5m.shp")
US_sf = st_as_sf(US)
US_sf_lcc = st_transform(US_sf, crs_projected)
UnitedStates <- st_cast(US_sf_lcc$geometry, "POLYGON")

```

## projected plot of SEARCH monitors + wheelabrator over Bmore shapefile
```{r}

plot(Bmore, col = 5, alpha=0.3)
plot(wheelabrator_sf_lcc,pch = 16, col = 7, alpha=0.4, add=T)
plot(search_sites_sf_lcc, 
      pch = 16, cex = 0.01, col = 2, 
      add=T) 


```

## unprojected plot of SEARCG monitors + wheelabrator over Bmore shapefile
```{r}
#plot(Maryland, col = 5)
plot(Bmore_polygon, col = 5, alpha=0.3)
plot(wheelabrator_sf,pch = 16, col = 7, alpha=0.4, add=T)
plot(search_narr_sf, 
      pch = 16, cex = 0.01, col = 2, 
      add=T) 

```


# creating the NARR + SEARCH air temp dataset

## extracting raster values from beneath search monitor points

```{r}
air.extract = raster::extract(air.2018, search_sites_sf)

#exporting result as a dataframe
PointData = cbind(search_sites_sf,air.extract) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

```

## tidying data, creating date column and manipulating temperature values

### wide to long transformation

```{r}
air.extract.2018 <- PointData %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "temperature") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))
```


### creating the date column

```{r}
air.extract.2018 <- air.extract.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , air.extract.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

#converting from kelvin to celsius
air.extract.2018$temperature = air.extract.2018$temperature - 273.15
```


# creating the wind dataset (narr_wind)

## 2018 wind dataset (wind.2018)
### u-wind 2018

```{r}
uwind.extract.2018 = raster::extract(uwind.2018.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2018 = cbind(search_sites_sf, uwind.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2018 <- uwind.tibble.2018 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2018 <- uwind.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2018
```{r}
vwind.extract.2018 = raster::extract(vwind.2018.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2018 = cbind(search_sites_sf, vwind.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2018 <- vwind.tibble.2018 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2018 <- vwind.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v component datasets

```{r}
winds_joined2018 = inner_join(uwind.2018, vwind.2018)

```

### calculating wind direction and speed 

```{r}
wind.2018 <- winds_joined2018 %>% 
  mutate(wind_direction = paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```

## 2019 wind dataset (wind.2019)
### u-wind 2019

```{r}
uwind.extract.2019 = raster::extract(uwind.2019.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2019 = cbind(search_sites_sf, uwind.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2019 <- uwind.tibble.2019 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2019 <- uwind.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2019
```{r}
vwind.extract.2019 = raster::extract(vwind.2019.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2019 = cbind(search_sites_sf, vwind.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2019 <- vwind.tibble.2019 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2019 <- vwind.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v component datasets

```{r}
winds_joined2019 = inner_join(uwind.2019, vwind.2019)

```

### calculating wind direction and speed 

```{r}
narr_wind_2019 <- winds_joined2019 %>% 
  mutate(wind_direction = paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```

## 2020 wind dataset (wind.2020)
### u-wind 2020

```{r}
uwind.extract.2020 = raster::extract(uwind.2020.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2020 = cbind(search_sites_sf, uwind.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2020 <- uwind.tibble.2020 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2020 <- uwind.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2020
```{r}
vwind.extract.2020 = raster::extract(vwind.2020.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2020 = cbind(search_sites_sf, vwind.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2020 <- vwind.tibble.2020 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2020 <- vwind.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v component datasets

```{r}
winds_joined2020 = inner_join(uwind.2020, vwind.2020)

```

### calculating wind direction and speed 

```{r}
narr_wind_2020 <- winds_joined2020 %>% 
  mutate(wind_direction = paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```



# creating the narr super dataset + data tidying
## creating the wind dataset (2018 to 2020)

### u-wind 2018

```{r}
# extracting raster values from search monitor locations
uwind.extract.2018 = raster::extract(uwind.2018.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2018 = cbind(search_sites_sf, uwind.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2018 <- uwind.tibble.2018 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2018 <- uwind.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2018
```{r}
# extracting raster values from search monitor locations
vwind.extract.2018 = raster::extract(vwind.2018.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2018 = cbind(search_sites_sf, vwind.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2018 <- vwind.tibble.2018 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2018 <- vwind.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v components + calculating wind direction and speed

```{r}
# merging the u-wind and v-wind components
winds_joined2018 = inner_join(uwind.2018, vwind.2018)

# calculating wind direction and wind speed
wind.2018 <- winds_joined2018 %>% 
#creating a new column for wind direction using arctan(u,v) 
    mutate(wind_direction = 
# (180/pi) <- converts to to degrees from radians
# (+ 180) <- makes degree range (0, 360) instead of (-180,180)
             paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```

### u-wind 2019

```{r}
# extracting raster values from search monitor locations
uwind.extract.2019 = raster::extract(uwind.2019.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2019 = cbind(search_sites_sf, uwind.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2019 <- uwind.tibble.2019 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2019 <- uwind.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2019
```{r}
# extracting raster values from search monitor locations
vwind.extract.2019 = raster::extract(vwind.2019.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2019 = cbind(search_sites_sf, vwind.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2019 <- vwind.tibble.2019 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2019 <- vwind.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v components + calculating wind direction and speed

```{r}
# merging the u-wind and v-wind components
winds_joined2019 = inner_join(uwind.2019, vwind.2019)

# calculating wind direction and wind speed
wind.2019 <- winds_joined2019 %>% 
#creating a new column for wind direction using arctan(u,v) 
    mutate(wind_direction = 
# (180/pi) <- converts to to degrees from radians
# (+ 180) <- makes degree range (0, 360) instead of (-180,180)
             paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```


### u-wind 2020

```{r}
# extracting raster values from search monitor locations
uwind.extract.2020 = raster::extract(uwind.2020.raster, search_sites_sf)

#exporting result as a dataframe
uwind.tibble.2020 = cbind(search_sites_sf, uwind.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
uwind.2020 <- uwind.tibble.2020 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "u_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

uwind.2020 <- uwind.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , uwind.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### v-wind 2020
```{r}
# extracting raster values from search monitor locations
vwind.extract.2020 = raster::extract(vwind.2020.raster, search_sites_sf)

#exporting result as a dataframe
vwind.tibble.2020 = cbind(search_sites_sf, vwind.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

### wide to long transformation
vwind.2020 <- vwind.tibble.2020 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "v_wind") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

vwind.2020 <- vwind.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , vwind.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 
```

### merging u and v components + calculating wind direction and speed

```{r}

# merging the u-wind and v-wind components
winds_joined2020 = inner_join(uwind.2020, vwind.2020)

# calculating wind direction and wind speed
wind.2020 <- winds_joined2020 %>% 
#creating a new column for wind direction using arctan(u,v) 
    mutate(wind_direction = 
# (180/pi) <- converts to to degrees from radians
# (+ 180) <- makes degree range (0, 360) instead of (-180,180)
             paste(((180/pi)*(atan2(u_wind,v_wind))+180))) %>% 
  mutate(wind_speed = sqrt(u_wind^2+v_wind^2))

```

## creating air temp dataset (2018 to 2020)

### air temp 2018

```{r}
# extracting air temp raster values from search monitor points
air.extract.2018 = raster::extract(air.2018.raster, search_sites_sf)

# exporting result as a dataframe
air.tibble.2018 = cbind(search_sites_sf, air.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

air.2018 <- air.tibble.2018 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "temperature") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
air.2018 <- air.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , air.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

#converting from kelvin to celsius
air.2018$temperature = air.2018$temperature - 273.15

```

### air temp 2019

```{r}
# extracting air temp raster values from search monitor points
air.extract.2019 = raster::extract(air.2019.raster, search_sites_sf)

# exporting result as a dataframe
air.tibble.2019 = cbind(search_sites_sf, air.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

air.2019 <- air.tibble.2019 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "temperature") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
air.2019 <- air.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , air.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

#converting from kelvin to celsius
air.2019$temperature = air.2019$temperature - 273.15

```

### air temp 2020

```{r}
# extracting air temp raster values from search monitor points
air.extract.2020 = raster::extract(air.2020.raster, search_sites_sf)

# exporting result as a dataframe
air.tibble.2020 = cbind(search_sites_sf, air.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

air.2020 <- air.tibble.2020 %>%
### converting from wide to long, creating the temperature column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "temperature") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
air.2020 <- air.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , air.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

#converting from kelvin to celsius
air.2020$temperature = air.2020$temperature - 273.15

```

## creating relative humidity dataset (2018 to 2020)

### relative humidity 2018

```{r}
# extracting rhum raster values from search monitor points
rhum.extract.2018 = raster::extract(rhum.2018.raster, search_sites_sf)

# exporting result as a dataframe
rhum.tibble.2018 = cbind(search_sites_sf, rhum.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

rhum.2018 <- rhum.tibble.2018 %>%
### converting from wide to long, creating the rhum column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "rhum") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
rhum.2018 <- rhum.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , rhum.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### relative humidity 2019

```{r}
# extracting rhum raster values from search monitor points
rhum.extract.2019 = raster::extract(rhum.2019.raster, search_sites_sf)

# exporting result as a dataframe
rhum.tibble.2019 = cbind(search_sites_sf, rhum.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

rhum.2019 <- rhum.tibble.2019 %>%
### converting from wide to long, creating the rhum column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "rhum") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
rhum.2019 <- rhum.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , rhum.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### relative humidity 2020

```{r}
# extracting rhum raster values from search monitor points
rhum.extract.2020 = raster::extract(rhum.2020.raster, search_sites_sf)

# exporting result as a dataframe
rhum.tibble.2020 = cbind(search_sites_sf, rhum.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

rhum.2020 <- rhum.tibble.2020 %>%
### converting from wide to long, creating the rhum column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "rhum") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
rhum.2020 <- rhum.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , rhum.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 


```


## Creating precipitation dataset (2018 to 2020)

### precipitation 2018

```{r}
# extracting precip raster values from search monitor points
precip.extract.2018 = raster::extract(precip.2018.raster, search_sites_sf)

# exporting result as a dataframe
precip.tibble.2018 = cbind(search_sites_sf, precip.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

precip.2018 <- precip.tibble.2018 %>%
### converting from wide to long, creating the precip column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "precip") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
precip.2018 <- precip.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , precip.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### precipitation 2019

```{r}
# extracting precip raster values from search monitor points
precip.extract.2019 = raster::extract(precip.2019.raster, search_sites_sf)

# exporting result as a dataframe
precip.tibble.2019 = cbind(search_sites_sf, precip.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

precip.2019 <- precip.tibble.2019 %>%
### converting from wide to long, creating the precip column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "precip") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
precip.2019 <- precip.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , precip.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### precipitation 2020

```{r}
# extracting precip raster values from search monitor points
precip.extract.2020 = raster::extract(precip.2020.raster, search_sites_sf)

# exporting result as a dataframe
precip.tibble.2020 = cbind(search_sites_sf, precip.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

precip.2020 <- precip.tibble.2020 %>%
### converting from wide to long, creating the precip column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "precip") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
precip.2020 <- precip.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , precip.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```


## creating albedo dataset (2018 to 2020)

### albedo 2018

```{r}
# extracting albedo raster values from search monitor points
albedo.extract.2018 = raster::extract(albedo.2018.raster, search_sites_sf)

# exporting result as a dataframe
albedo.tibble.2018 = cbind(search_sites_sf, albedo.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

albedo.2018 <- albedo.tibble.2018 %>%
### converting from wide to long, creating the albedo column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "albedo") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
albedo.2018 <- albedo.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , albedo.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### albedo 2019

```{r}
# extracting albedo raster values from search monitor points
albedo.extract.2019 = raster::extract(albedo.2019.raster, search_sites_sf)

# exporting result as a dataframe
albedo.tibble.2019 = cbind(search_sites_sf, albedo.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

albedo.2019 <- albedo.tibble.2019 %>%
### converting from wide to long, creating the albedo column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "albedo") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
albedo.2019 <- albedo.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , albedo.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### albedo 2020

```{r}
# extracting albedo raster values from search monitor points
albedo.extract.2020 = raster::extract(albedo.2020.raster, search_sites_sf)

# exporting result as a dataframe
albedo.tibble.2020 = cbind(search_sites_sf, albedo.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

albedo.2020 <- albedo.tibble.2020 %>%
### converting from wide to long, creating the albedo column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "albedo") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
albedo.2020 <- albedo.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , albedo.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

## creating planetary boundary layer height dataset (2018 to 2020)

### planetary boundary layer height 2018

```{r}
# extracting planetary boundary layer height raster values from search monitor points
pblh.extract.2018 = raster::extract(pblh.2018.raster, search_sites_sf)

# exporting result as a dataframe
pblh.tibble.2018 = cbind(search_sites_sf, pblh.extract.2018) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

pblh.2018 <- pblh.tibble.2018 %>%
### converting from wide to long, creating the pblh column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "pblh") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
pblh.2018 <- pblh.2018 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , pblh.2018$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### planetary boundary layer height 2019

```{r}
# extracting planetary boundary layer height raster values from search monitor points
pblh.extract.2019 = raster::extract(pblh.2019.raster, search_sites_sf)

# exporting result as a dataframe
pblh.tibble.2019 = cbind(search_sites_sf, pblh.extract.2019) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

pblh.2019 <- pblh.tibble.2019 %>%
### converting from wide to long, creating the pblh column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "pblh") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
pblh.2019 <- pblh.2019 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , pblh.2019$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```

### planetary boundary layer height 2020

```{r}
# extracting planetary boundary layer height raster values from search monitor points
pblh.extract.2020 = raster::extract(pblh.2020.raster, search_sites_sf)

# exporting result as a dataframe
pblh.tibble.2020 = cbind(search_sites_sf, pblh.extract.2020) %>% 
  as_tibble() %>%
  dplyr::select(-geometry)

pblh.2020 <- pblh.tibble.2020 %>%
### converting from wide to long, creating the pblh column, and naming the dates column "day_of_year" while creating a new column date column without the x character
    pivot_longer(-Site_Number, 
                 names_to  = "day_of_year",
                 values_to = "pblh") %>% 
  mutate(date1 = str_sub(day_of_year, 2, -1))

# creating the date column
pblh.2020 <- pblh.2020 %>% 
  #creating a new date column that replaces "." with "/"
  mutate(date2 = paste(gsub("[.]", "/" , pblh.2020$date1))) %>% 
  # date column -> date column type format
  mutate(date = paste(as.Date(date2, format = "%Y/%m/%d"))) %>% 
  #removing excess column to create finalized date column
  dplyr::select(-day_of_year, -date1, -date2) 

```


## merging datasets by year

### 2018
```{r}
inner_join(wind.2018, precip.2018, rhum.2018, pblh.2018)

```


# exposure assesment



## 6-assess_exposure_annuli_wind.R code

```{r}

# prepares the monitor dataset
  
  # captures date for feeding into the function below
  monitor_date   <- monitor$date
  monitor_lat    <- unlist(map(monitor$geometry, 1))
  monitor_long   <- unlist(map(monitor$geometry, 2))
  wind_direction <- monitor$narr_wind_direction
  
  # keeps only 'site_id'
  monitor <- monitor %>% select(site_id)

------------------------------------------------------------------------   

 ## creates a "wedge" facing towards the upwind origin point (point0)
    
    # captures monitor point from the coordinates
    monitor_point <- matrix(c(monitor_lat, monitor_long),
                            ncol = 2, byrow = TRUE)
    colnames(monitor_point) <- c('lat', 'long') 
    monitor_point <- as.tibble(monitor_point) %>%
      mutate(lat  = as.numeric(lat), long = as.numeric(long))
 
    # calculating upwind vector and creating a matrix
    upwind_point0 <- matrix(c((monitor_lat  + ((20/110.574) *  
                                                 cos(wind_direction * (pi/180)))),
                              (monitor_long + ((20/110.574) * 
                                                 sin(wind_direction * (pi/180))))),
                            ncol = 2, byrow = TRUE)
    colnames(upwind_point0) <- c('lat', 'long') 
    upwind_point0 <- as.tibble(upwind_point0) %>%
      mutate(lat  = as.numeric(lat), long = as.numeric(long))
    
    # calculating upwind points on either side of the wind direction
    # first point
    upwind_point1 <-
      matrix(c((monitor_lat  + (((20 / 110.574) / cos(45 * (pi/180))) * 
                                  cos((wind_direction + 45) * (pi/180)))),
               (monitor_long + (((20 / 110.574) / cos(45 * (pi/180))) *
                                  sin((wind_direction + 45) * (pi/180))))),
             ncol = 2, byrow = TRUE)
    colnames(upwind_point1) <- c('lat', 'long')
    upwind_point1 <- as.tibble(upwind_point1) %>%
      mutate(lat  = as.numeric(lat), long = as.numeric(long))
    
    # second point
    upwind_point2 <- 
      matrix(c((monitor_lat + (((20 / 110.574) / cos(45 * (pi/180))) *
                                 cos((wind_direction - 45) * (pi/180)))),
               (monitor_long + (((20 / 110.574) / cos(45 * (pi/180)))*
                                  sin((wind_direction - 45) * (pi/180))))),
             ncol = 2, byrow = TRUE)
    colnames(upwind_point2) <- c('lat', 'long')
    upwind_point2 <- as.tibble(upwind_point2) %>%
      mutate(lat  = as.numeric(lat), long = as.numeric(long))
    
    # makes the first half of the "wedge"
    wedge1 <- full_join(upwind_point1, upwind_point0) %>% 
      full_join(y = monitor_point)
    wedge1 <- st_as_sf(wedge1, coords = c("lat", "long"))
    st_crs(wedge1) <- crs_nad83
    wedge1 <- wedge1 %>%
      st_coordinates() %>%
      st_multipoint() %>% 
      st_cast("POLYGON") %>% 
      st_sfc(crs = crs_nad83)
    
    # makes the second half of the "wedge"
    wedge2 <- full_join(upwind_point2, upwind_point0) %>% 
      full_join(y = monitor_point) 
    wedge2 <- st_as_sf(wedge2, coords = c("lat", "long"))
    st_crs(wedge2) <- crs_nad83
    wedge2 <- wedge2 %>% 
      st_coordinates() %>%
      st_multipoint() %>% 
      st_cast("POLYGON") %>%
      st_sfc(crs = crs_nad83)
    
    # combines the two halves into the full wedge
    upwind_wedge <- st_union(wedge1, wedge2)

```

## creating a subset of data for looping practice
```{r}
subset <- filter(dat, date == "2018-01-01")

```

## creating a for loop for calculating wind direction

```{r}
narr_wind <- tibble()

for (){
  print(i + 273.15)
}

```


